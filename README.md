# n-gram + AC自动机为基础实现的词库检索、文本相似检索

# 简介

## 一、功能概述

### 1. AC Class用于海量词库快速检索

### 2. TextSimilaritySearch Class用于大量文本的快速相似检索

## 二、特点概述

### 1. 高效率查询

2493896个词语的词库匹配只需0.05ms。

800003个文本(平均平均每个文本233chars)文本相似检索只需116.738ms。

<font color="blue">TODO 后续会采用多线程加速文本相似检索，大幅度提升查询效率。</font>

### 2. 高查全率（召回率）

首先n-gram方式本身很容易查到相似文本。

此外，本程序支持替换库，通过近义词、简称补全、类型追加进一步提升召回率。

### 3. 可调参以适应不同的需求

有很多不同方面的因素能影响查询结果，本程序支持<strong>控制参数</strong>来调节不同因素的影响力。

此外，AvgIdfGrowthCalculator提供了默认的得分差异化计算函数，可继承扩展，实现自定义的计算方法。

### 4. 无需训练，可控性好

无需训练，由于替换库的存在，相似语义变得可定义、可控制。

如果结合其他模型，比如<strong>词语类型分析</strong>、<strong>词语相似计算</strong>，也可以帮助生成替换库。（<strong>自动化</strong>）

### 5. 高内存占用

由于查询速度的提升是一种空间换时间的方法，因此有较高的内存占用。

### 6. 适合查询频繁，不频繁更新的场合

由于数据变更会导致失配指针和统计参数变化，需要较长的更新时间。原本设计的使用场合，是大量频繁查询，很少更新或者利用闲时更新。

##### 如果你也想支持频繁更新，就需要采用读写分离：

主库用于查询，小库用于更新和查询。

（1）新增文章时，插入到小库。（小库的数量可以大于1）

（2）查询时候，主库和小库同时查询，整合结果返回。

（3）在合适的时机（比如小库达到了一定数量或者闲时状态），合并为一个主库，持久化、加载并替换正在使用的主库对象。

这属于工程化的内容，我并没有编写相关的功能。

### 7. 多语言支持

本程序提供[Java版本](README_java_call.md)和[Python版本](README_python_call.md)调用方式

## 三、效率统计

### 时间效率分析

### 1. AC词库匹配时间

```text
词库词数 2493896
输入文本长度 31chars
词库匹配所需时间 0.05ms
匹配时间主要与输入长度有关，受库内文本数量影响小。
```

### 2. 相似检索相关时间

入库文章数量: 88480(每个文章平均398.2071993670886 chars)

```text
搜索操作：
相似搜索时间: 14.352ms

入库操作：
插入文章时间：75.226s
刷新索引时间：8.807s

保存库操作：
持久化时间：47.818s

加载操作：
加载时间：20.257s （程序启动只需一次）
```

入库文章数量: 800003(每个文章平均233.0957046411076 chars)

```text
搜索操作：
相似搜索: 116.738ms

入库操作：
插入文章时间：1446.497s
刷新索引时间：90.8s

保存库操作：
持久化时间：477.163s

加载操作：
加载时间：181.485s（程序启动只需一次）
```

<font color="blue">TODO 利用图表展示</font>

### 空间效率统计

```text
入库文章数量: 88480(平均398.2071993670886 chars)，磁盘空间占用约1.2GB，内存占用约9G。

入库文章数量: 800003(平均233.0957046411076 chars)，磁盘空间占用约5.1GB，内存占用约24G。
```

## 三、安装

安装本程序，见[README_install.md](README_install.md)

## 四、使用方法

以下都有JAVA和python代码

java说明见[README_java_call.md](README_java_call.md)

java代码示例见[TempTest.java](src%2Fcom%2Faldebran%2Ftext%2FTempTest.java)

python说明见[README_python_call.md](README_python_call.md)

python代码示例见[python_call_example.py](python_call_example.py)

python调用时，效率仅为java调用的0.55-0.65，但时间在可接受范围内。

## 五、替换库说明（见replace.txt，可自定义追加）

格式说明

```text
# 停止词，标点符号
·
`
。
.

# 停止词，中文字词
的
了

# 相似词语
高兴 快乐

# 类别追加
SUV SUV运动型多用途汽车
```

原则

```text
（1）停止词是必备的，减少干扰。一行只需一个词（字）。

（2）相似词语替换可进一步增加召回率（查全率），不过对于知识检索领域，没有相似词库也能取得较好的效果。

（3）类别追加，增加搜索的通用性，比如追加全称，或者追加一个类型。例如“老虎 猫科”，这会显著增加召回率（查全率），但是精确率可能会有所降低（误杀率提高）。
（score可能会变得比较高，但排名不变）

（4）无论n-gram中的n多大，如果一个词是单字词，最好扩展为双字，能增加查全率。比如“狗 狗狗”。
```

## 六、注意事项

```text
1. 当文章非常多的时候，要指定很大的Xss和Xms，例如：
-Xss1024m -Xms30g

```

## 七、TODO

```text
1. 数字目前不支持精确匹配，有需求应追加参数控制。

2. AvgIdfGrowthCalculator采用线性均匀增加方式计算gram idf差异化得分，依靠idfGrowthK参数控制区分度。

可继承AvgIdfGrowthCalculator实现Sigmoid类S型曲线，扩大期望值附近的得分差距，减少高分之间（低分之间）的差距。
或者实现x^3类S型曲线，减少期望值附近的得分差距，增加高分之间（低分之间）的差距。

3. 多线程查询，显著增加查询效率。

4. 文本相似库多线程导入导出，显著增加效率。

5. 效率测试图标绘制。

6. 利用map@1, map@10等评分指标，利用开源数据集计算评分值。
```

## 八、效率测试平台说明

```text
处理器：intel i9-12900HX 16核24线程
内存：32G物理内存 4800MHz
操作系统：Windows11
Java版本：GrailVM JDK 21
```

# 兄弟项目

https://github.com/aldebran97/springboot_text_toolkit/tree/master

提供了API访问方式

